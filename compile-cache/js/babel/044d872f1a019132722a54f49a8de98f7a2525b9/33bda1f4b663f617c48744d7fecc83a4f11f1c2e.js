'use babel';
'use strict';

var path = require('path');
var fs = require('fs');
var _ = require('lodash');
var CSON = require('cson-parser');

module.exports.niceName = 'Custom file';

function getConfig(file) {
  var realFile = fs.realpathSync(file);
  delete require.cache[realFile];
  switch (path.extname(file)) {
    case '.json':
      return require(realFile);

    case '.cson':
      var content = fs.readFileSync(realFile);
      return CSON.parse(content);
  }
}

function createBuildConfig(build, name) {
  return {
    name: 'Custom: ' + name,
    exec: build.cmd,
    env: build.env,
    args: build.args,
    cwd: build.cwd,
    sh: build.sh,
    errorMatch: build.errorMatch,
    keymap: build.keymap
  };
}

module.exports.isEligable = function (cwd) {
  this.files = _(['.atom-build.json', '.atom-build.cson']).map(function (file) {
    return path.join(cwd, file);
  }).filter(fs.existsSync).value();
  return 0 < this.files.length;
};

module.exports.settings = function (cwd) {

  var config = [];
  this.files.map(getConfig).forEach(function (build) {
    config.push(createBuildConfig(build, build.name || 'default'));
    _.forEach(build.targets || [], function (target, name) {
      config.push(createBuildConfig(target, name));
    });
  });

  return config;
};

var fileWatchers = [];
module.exports.on = function (ev, cb) {
  if ('refresh' !== ev || !this.files) {
    return;
  }

  fileWatchers.forEach(function (watcher) {
    watcher.close();
  });

  fileWatchers = this.files.map(function (file) {
    return fs.watch(file, cb);
  });
};

module.exports.off = function (ev) {
  if ('refresh' !== ev) {
    return;
  }

  fileWatchers.forEach(function (watcher) {
    watcher.close();
  });
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL2NoYW1wLy5hdG9tL3BhY2thZ2VzL2J1aWxkL2xpYi9hdG9tLWJ1aWxkLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFdBQVcsQ0FBQztBQUNaLFlBQVksQ0FBQzs7QUFFYixJQUFJLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDM0IsSUFBSSxFQUFFLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ3ZCLElBQUksQ0FBQyxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUMxQixJQUFJLElBQUksR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7O0FBRWxDLE1BQU0sQ0FBQyxPQUFPLENBQUMsUUFBUSxHQUFHLGFBQWEsQ0FBQzs7QUFFeEMsU0FBUyxTQUFTLENBQUMsSUFBSSxFQUFFO0FBQ3ZCLE1BQUksUUFBUSxHQUFHLEVBQUUsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDckMsU0FBTyxPQUFPLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQy9CLFVBQVEsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUM7QUFDMUIsU0FBSyxPQUFPO0FBQ1YsYUFBTyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7O0FBQUEsQUFFM0IsU0FBSyxPQUFPO0FBQ1YsVUFBSSxPQUFPLEdBQUcsRUFBRSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUN4QyxhQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7QUFBQSxHQUM1QjtDQUNGOztBQUVELFNBQVMsaUJBQWlCLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRTtBQUN0QyxTQUFPO0FBQ0wsUUFBSSxFQUFFLFVBQVUsR0FBRyxJQUFJO0FBQ3ZCLFFBQUksRUFBRSxLQUFLLENBQUMsR0FBRztBQUNmLE9BQUcsRUFBRSxLQUFLLENBQUMsR0FBRztBQUNkLFFBQUksRUFBRSxLQUFLLENBQUMsSUFBSTtBQUNoQixPQUFHLEVBQUUsS0FBSyxDQUFDLEdBQUc7QUFDZCxNQUFFLEVBQUUsS0FBSyxDQUFDLEVBQUU7QUFDWixjQUFVLEVBQUUsS0FBSyxDQUFDLFVBQVU7QUFDNUIsVUFBTSxFQUFFLEtBQUssQ0FBQyxNQUFNO0dBQ3JCLENBQUM7Q0FDSDs7QUFFRCxNQUFNLENBQUMsT0FBTyxDQUFDLFVBQVUsR0FBRyxVQUFVLEdBQUcsRUFBRTtBQUN6QyxNQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFFLGtCQUFrQixFQUFFLGtCQUFrQixDQUFFLENBQUMsQ0FDdkQsR0FBRyxDQUFDLFVBQUEsSUFBSSxFQUFJO0FBQUUsV0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQztHQUFFLENBQUMsQ0FDN0MsTUFBTSxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsQ0FDckIsS0FBSyxFQUFFLENBQUM7QUFDWCxTQUFPLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQztDQUM5QixDQUFDOztBQUVGLE1BQU0sQ0FBQyxPQUFPLENBQUMsUUFBUSxHQUFHLFVBQVUsR0FBRyxFQUFFOztBQUV2QyxNQUFJLE1BQU0sR0FBRyxFQUFFLENBQUM7QUFDaEIsTUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQUEsS0FBSyxFQUFJO0FBQ3pDLFVBQU0sQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxJQUFJLElBQUksU0FBUyxDQUFDLENBQUMsQ0FBQztBQUMvRCxLQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxPQUFPLElBQUksRUFBRSxFQUFFLFVBQUMsTUFBTSxFQUFFLElBQUksRUFBSztBQUMvQyxZQUFNLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO0tBQzlDLENBQUMsQ0FBQztHQUNKLENBQUMsQ0FBQzs7QUFFSCxTQUFPLE1BQU0sQ0FBQztDQUNmLENBQUM7O0FBRUYsSUFBSSxZQUFZLEdBQUcsRUFBRSxDQUFDO0FBQ3RCLE1BQU0sQ0FBQyxPQUFPLENBQUMsRUFBRSxHQUFHLFVBQVUsRUFBRSxFQUFFLEVBQUUsRUFBRTtBQUNwQyxNQUFJLFNBQVMsS0FBSyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFO0FBQ25DLFdBQU87R0FDUjs7QUFFRCxjQUFZLENBQUMsT0FBTyxDQUFDLFVBQUEsT0FBTyxFQUFJO0FBQzlCLFdBQU8sQ0FBQyxLQUFLLEVBQUUsQ0FBQztHQUNqQixDQUFDLENBQUM7O0FBRUgsY0FBWSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFVBQUEsSUFBSSxFQUFJO0FBQ3BDLFdBQU8sRUFBRSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7R0FDM0IsQ0FBQyxDQUFDO0NBQ0osQ0FBQzs7QUFFRixNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsR0FBRyxVQUFVLEVBQUUsRUFBRTtBQUNqQyxNQUFJLFNBQVMsS0FBSyxFQUFFLEVBQUU7QUFDcEIsV0FBTztHQUNSOztBQUVELGNBQVksQ0FBQyxPQUFPLENBQUMsVUFBQSxPQUFPLEVBQUk7QUFDOUIsV0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDO0dBQ2pCLENBQUMsQ0FBQztDQUNKLENBQUMiLCJmaWxlIjoiL2hvbWUvY2hhbXAvLmF0b20vcGFja2FnZXMvYnVpbGQvbGliL2F0b20tYnVpbGQuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIGJhYmVsJztcbid1c2Ugc3RyaWN0JztcblxudmFyIHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG52YXIgZnMgPSByZXF1aXJlKCdmcycpO1xudmFyIF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcbnZhciBDU09OID0gcmVxdWlyZSgnY3Nvbi1wYXJzZXInKTtcblxubW9kdWxlLmV4cG9ydHMubmljZU5hbWUgPSAnQ3VzdG9tIGZpbGUnO1xuXG5mdW5jdGlvbiBnZXRDb25maWcoZmlsZSkge1xuICB2YXIgcmVhbEZpbGUgPSBmcy5yZWFscGF0aFN5bmMoZmlsZSk7XG4gIGRlbGV0ZSByZXF1aXJlLmNhY2hlW3JlYWxGaWxlXTtcbiAgc3dpdGNoIChwYXRoLmV4dG5hbWUoZmlsZSkpIHtcbiAgY2FzZSAnLmpzb24nOlxuICAgIHJldHVybiByZXF1aXJlKHJlYWxGaWxlKTtcblxuICBjYXNlICcuY3Nvbic6XG4gICAgdmFyIGNvbnRlbnQgPSBmcy5yZWFkRmlsZVN5bmMocmVhbEZpbGUpO1xuICAgIHJldHVybiBDU09OLnBhcnNlKGNvbnRlbnQpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZUJ1aWxkQ29uZmlnKGJ1aWxkLCBuYW1lKSB7XG4gIHJldHVybiB7XG4gICAgbmFtZTogJ0N1c3RvbTogJyArIG5hbWUsXG4gICAgZXhlYzogYnVpbGQuY21kLFxuICAgIGVudjogYnVpbGQuZW52LFxuICAgIGFyZ3M6IGJ1aWxkLmFyZ3MsXG4gICAgY3dkOiBidWlsZC5jd2QsXG4gICAgc2g6IGJ1aWxkLnNoLFxuICAgIGVycm9yTWF0Y2g6IGJ1aWxkLmVycm9yTWF0Y2gsXG4gICAga2V5bWFwOiBidWlsZC5rZXltYXBcbiAgfTtcbn1cblxubW9kdWxlLmV4cG9ydHMuaXNFbGlnYWJsZSA9IGZ1bmN0aW9uIChjd2QpIHtcbiAgdGhpcy5maWxlcyA9IF8oWyAnLmF0b20tYnVpbGQuanNvbicsICcuYXRvbS1idWlsZC5jc29uJyBdKVxuICAgIC5tYXAoZmlsZSA9PiB7IHJldHVybiBwYXRoLmpvaW4oY3dkLCBmaWxlKTsgfSlcbiAgICAuZmlsdGVyKGZzLmV4aXN0c1N5bmMpXG4gICAgLnZhbHVlKCk7XG4gIHJldHVybiAwIDwgdGhpcy5maWxlcy5sZW5ndGg7XG59O1xuXG5tb2R1bGUuZXhwb3J0cy5zZXR0aW5ncyA9IGZ1bmN0aW9uIChjd2QpIHtcblxuICBsZXQgY29uZmlnID0gW107XG4gIHRoaXMuZmlsZXMubWFwKGdldENvbmZpZykuZm9yRWFjaChidWlsZCA9PiB7XG4gICAgY29uZmlnLnB1c2goY3JlYXRlQnVpbGRDb25maWcoYnVpbGQsIGJ1aWxkLm5hbWUgfHzCoCdkZWZhdWx0JykpO1xuICAgIF8uZm9yRWFjaChidWlsZC50YXJnZXRzIHx8IFtdLCAodGFyZ2V0LCBuYW1lKSA9PiB7XG4gICAgICBjb25maWcucHVzaChjcmVhdGVCdWlsZENvbmZpZyh0YXJnZXQsIG5hbWUpKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgcmV0dXJuIGNvbmZpZztcbn07XG5cbmxldCBmaWxlV2F0Y2hlcnMgPSBbXTtcbm1vZHVsZS5leHBvcnRzLm9uID0gZnVuY3Rpb24gKGV2LCBjYikge1xuICBpZiAoJ3JlZnJlc2gnICE9PSBldiB8fCAhdGhpcy5maWxlcykge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGZpbGVXYXRjaGVycy5mb3JFYWNoKHdhdGNoZXIgPT4ge1xuICAgIHdhdGNoZXIuY2xvc2UoKTtcbiAgfSk7XG5cbiAgZmlsZVdhdGNoZXJzID0gdGhpcy5maWxlcy5tYXAoZmlsZSA9PiB7XG4gICAgcmV0dXJuIGZzLndhdGNoKGZpbGUsIGNiKTtcbiAgfSk7XG59O1xuXG5tb2R1bGUuZXhwb3J0cy5vZmYgPSBmdW5jdGlvbiAoZXYpIHtcbiAgaWYgKCdyZWZyZXNoJyAhPT0gZXYpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICBmaWxlV2F0Y2hlcnMuZm9yRWFjaCh3YXRjaGVyID0+IHtcbiAgICB3YXRjaGVyLmNsb3NlKCk7XG4gIH0pO1xufTtcbiJdfQ==
//# sourceURL=/home/champ/.atom/packages/build/lib/atom-build.js
