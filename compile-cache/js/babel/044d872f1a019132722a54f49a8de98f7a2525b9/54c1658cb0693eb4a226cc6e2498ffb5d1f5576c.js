'use babel';
'use strict';

var _ = require('lodash');
var querystring = require('querystring');
var cid;

module.exports = (function () {
  atom.packages.onDidActivatePackage(function (pkg) {
    if ('metrics' === pkg.name) {
      var buildPackage = atom.packages.getLoadedPackage('build');
      GoogleAnalytics.sendEvent('core', 'activated', buildPackage.metadata.version);
    }
  });
  function GoogleAnalytics() {}

  GoogleAnalytics.getCid = function (cb) {
    if (cid) {
      return cb(cid);
    }

    require('getmac').getMac(function (error, macAddress) {
      if (error) {
        return cb(cid = require('node-uuid').v4());
      }

      return cb(require('crypto').createHash('sha1').update(macAddress, 'utf8').digest('hex'));
    });
  };

  GoogleAnalytics.sendEvent = function (category, action, label, value) {
    var params = {
      t: 'event',
      ec: category,
      ea: action
    };
    if (label) {
      params.el = label;
    }
    if (value) {
      params.ev = value;
    }

    GoogleAnalytics.send(params);
  };

  GoogleAnalytics.send = function (params) {
    if (!atom.packages.getActivePackage('metrics')) {
      // If the metrics package is disabled, then user has opted out.
      return;
    }

    GoogleAnalytics.getCid(function (cid) {
      _.extend(params, { cid: cid }, GoogleAnalytics.defaultParams());
      GoogleAnalytics.request('https://www.google-analytics.com/collect?' + querystring.stringify(params));
    });
  };

  GoogleAnalytics.request = function (url) {
    if (!navigator.onLine) {
      return;
    }
    GoogleAnalytics.post(url);
  };

  GoogleAnalytics.post = function (url) {
    var xhr = new XMLHttpRequest();
    xhr.open('POST', url);
    xhr.send(null);
  };

  GoogleAnalytics.defaultParams = function () {
    // https://developers.google.com/analytics/devguides/collection/protocol/v1/parameters
    return {
      v: 1,
      tid: 'UA-47615700-5'
    };
  };

  return GoogleAnalytics;
})();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL2NoYW1wLy5hdG9tL3BhY2thZ2VzL2J1aWxkL2xpYi9nb29nbGUtYW5hbHl0aWNzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFdBQVcsQ0FBQztBQUNaLFlBQVksQ0FBQzs7QUFFYixJQUFJLENBQUMsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDMUIsSUFBSSxXQUFXLEdBQUcsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0FBQ3pDLElBQUksR0FBRyxDQUFDOztBQUVSLE1BQU0sQ0FBQyxPQUFPLEdBQUcsQ0FBQyxZQUFZO0FBQzVCLE1BQUksQ0FBQyxRQUFRLENBQUMsb0JBQW9CLENBQUMsVUFBVSxHQUFHLEVBQUU7QUFDaEQsUUFBSSxTQUFTLEtBQUssR0FBRyxDQUFDLElBQUksRUFBRTtBQUMxQixVQUFJLFlBQVksR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQzNELHFCQUFlLENBQUMsU0FBUyxDQUFDLE1BQU0sRUFBRSxXQUFXLEVBQUUsWUFBWSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQztLQUMvRTtHQUNGLENBQUMsQ0FBQztBQUNILFdBQVMsZUFBZSxHQUFJLEVBQUU7O0FBRTlCLGlCQUFlLENBQUMsTUFBTSxHQUFHLFVBQVUsRUFBRSxFQUFFO0FBQ3JDLFFBQUksR0FBRyxFQUFFO0FBQ1AsYUFBTyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUM7S0FDaEI7O0FBRUQsV0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFTLEtBQUssRUFBRSxVQUFVLEVBQUU7QUFDbkQsVUFBSSxLQUFLLEVBQUU7QUFDVCxlQUFPLEVBQUUsQ0FBQyxHQUFHLEdBQUcsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7T0FDNUM7O0FBRUQsYUFBTyxFQUFFLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxNQUFNLENBQUMsVUFBVSxFQUFFLE1BQU0sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO0tBQzFGLENBQUMsQ0FBQztHQUNKLENBQUM7O0FBRUYsaUJBQWUsQ0FBQyxTQUFTLEdBQUcsVUFBUyxRQUFRLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUU7QUFDbkUsUUFBSSxNQUFNLEdBQUc7QUFDWCxPQUFDLEVBQUUsT0FBTztBQUNWLFFBQUUsRUFBRSxRQUFRO0FBQ1osUUFBRSxFQUFFLE1BQU07S0FDWCxDQUFDO0FBQ0YsUUFBSSxLQUFLLEVBQUU7QUFDVCxZQUFNLENBQUMsRUFBRSxHQUFHLEtBQUssQ0FBQztLQUNuQjtBQUNELFFBQUksS0FBSyxFQUFFO0FBQ1QsWUFBTSxDQUFDLEVBQUUsR0FBRyxLQUFLLENBQUM7S0FDbkI7O0FBRUQsbUJBQWUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7R0FDOUIsQ0FBQzs7QUFFRixpQkFBZSxDQUFDLElBQUksR0FBRyxVQUFVLE1BQU0sRUFBRTtBQUN2QyxRQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsRUFBRTs7QUFFOUMsYUFBTztLQUNSOztBQUVELG1CQUFlLENBQUMsTUFBTSxDQUFDLFVBQVUsR0FBRyxFQUFFO0FBQ3BDLE9BQUMsQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFLGVBQWUsQ0FBQyxhQUFhLEVBQUUsQ0FBQyxDQUFDO0FBQ2hFLHFCQUFlLENBQUMsT0FBTyxDQUFDLDJDQUEyQyxHQUFHLFdBQVcsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztLQUN0RyxDQUFDLENBQUM7R0FDSixDQUFDOztBQUVGLGlCQUFlLENBQUMsT0FBTyxHQUFHLFVBQVUsR0FBRyxFQUFFO0FBQ3ZDLFFBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxFQUFFO0FBQ3JCLGFBQU87S0FDUjtBQUNELG1CQUFlLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0dBQzNCLENBQUM7O0FBRUYsaUJBQWUsQ0FBQyxJQUFJLEdBQUcsVUFBVSxHQUFHLEVBQUU7QUFDcEMsUUFBSSxHQUFHLEdBQUcsSUFBSSxjQUFjLEVBQUUsQ0FBQztBQUMvQixPQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQztBQUN0QixPQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0dBQ2hCLENBQUM7O0FBRUYsaUJBQWUsQ0FBQyxhQUFhLEdBQUcsWUFBWTs7QUFFMUMsV0FBTztBQUNMLE9BQUMsRUFBRSxDQUFDO0FBQ0osU0FBRyxFQUFFLGVBQWU7S0FDckIsQ0FBQztHQUNILENBQUM7O0FBRUYsU0FBTyxlQUFlLENBQUM7Q0FDeEIsQ0FBQSxFQUFHLENBQUMiLCJmaWxlIjoiL2hvbWUvY2hhbXAvLmF0b20vcGFja2FnZXMvYnVpbGQvbGliL2dvb2dsZS1hbmFseXRpY3MuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIGJhYmVsJztcbid1c2Ugc3RyaWN0JztcblxudmFyIF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcbnZhciBxdWVyeXN0cmluZyA9IHJlcXVpcmUoJ3F1ZXJ5c3RyaW5nJyk7XG52YXIgY2lkO1xuXG5tb2R1bGUuZXhwb3J0cyA9IChmdW5jdGlvbiAoKSB7XG4gIGF0b20ucGFja2FnZXMub25EaWRBY3RpdmF0ZVBhY2thZ2UoZnVuY3Rpb24gKHBrZykge1xuICAgIGlmICgnbWV0cmljcycgPT09IHBrZy5uYW1lKSB7XG4gICAgICB2YXIgYnVpbGRQYWNrYWdlID0gYXRvbS5wYWNrYWdlcy5nZXRMb2FkZWRQYWNrYWdlKCdidWlsZCcpO1xuICAgICAgR29vZ2xlQW5hbHl0aWNzLnNlbmRFdmVudCgnY29yZScsICdhY3RpdmF0ZWQnLCBidWlsZFBhY2thZ2UubWV0YWRhdGEudmVyc2lvbik7XG4gICAgfVxuICB9KTtcbiAgZnVuY3Rpb24gR29vZ2xlQW5hbHl0aWNzICgpIHt9XG5cbiAgR29vZ2xlQW5hbHl0aWNzLmdldENpZCA9IGZ1bmN0aW9uIChjYikge1xuICAgIGlmIChjaWQpIHtcbiAgICAgIHJldHVybiBjYihjaWQpO1xuICAgIH1cblxuICAgIHJlcXVpcmUoJ2dldG1hYycpLmdldE1hYyhmdW5jdGlvbihlcnJvciwgbWFjQWRkcmVzcykge1xuICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgIHJldHVybiBjYihjaWQgPSByZXF1aXJlKCdub2RlLXV1aWQnKS52NCgpKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGNiKHJlcXVpcmUoJ2NyeXB0bycpLmNyZWF0ZUhhc2goJ3NoYTEnKS51cGRhdGUobWFjQWRkcmVzcywgJ3V0ZjgnKS5kaWdlc3QoJ2hleCcpKTtcbiAgICB9KTtcbiAgfTtcblxuICBHb29nbGVBbmFseXRpY3Muc2VuZEV2ZW50ID0gZnVuY3Rpb24oY2F0ZWdvcnksIGFjdGlvbiwgbGFiZWwsIHZhbHVlKSB7XG4gICAgdmFyIHBhcmFtcyA9IHtcbiAgICAgIHQ6ICdldmVudCcsXG4gICAgICBlYzogY2F0ZWdvcnksXG4gICAgICBlYTogYWN0aW9uXG4gICAgfTtcbiAgICBpZiAobGFiZWwpIHtcbiAgICAgIHBhcmFtcy5lbCA9IGxhYmVsO1xuICAgIH1cbiAgICBpZiAodmFsdWUpIHtcbiAgICAgIHBhcmFtcy5ldiA9IHZhbHVlO1xuICAgIH1cblxuICAgIEdvb2dsZUFuYWx5dGljcy5zZW5kKHBhcmFtcyk7XG4gIH07XG5cbiAgR29vZ2xlQW5hbHl0aWNzLnNlbmQgPSBmdW5jdGlvbiAocGFyYW1zKSB7XG4gICAgaWYgKCFhdG9tLnBhY2thZ2VzLmdldEFjdGl2ZVBhY2thZ2UoJ21ldHJpY3MnKSkge1xuICAgICAgLy8gSWYgdGhlIG1ldHJpY3MgcGFja2FnZSBpcyBkaXNhYmxlZCwgdGhlbiB1c2VyIGhhcyBvcHRlZCBvdXQuXG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgR29vZ2xlQW5hbHl0aWNzLmdldENpZChmdW5jdGlvbiAoY2lkKSB7XG4gICAgICBfLmV4dGVuZChwYXJhbXMsIHsgY2lkOiBjaWQgfSwgR29vZ2xlQW5hbHl0aWNzLmRlZmF1bHRQYXJhbXMoKSk7XG4gICAgICBHb29nbGVBbmFseXRpY3MucmVxdWVzdCgnaHR0cHM6Ly93d3cuZ29vZ2xlLWFuYWx5dGljcy5jb20vY29sbGVjdD8nICsgcXVlcnlzdHJpbmcuc3RyaW5naWZ5KHBhcmFtcykpO1xuICAgIH0pO1xuICB9O1xuXG4gIEdvb2dsZUFuYWx5dGljcy5yZXF1ZXN0ID0gZnVuY3Rpb24gKHVybCkge1xuICAgIGlmICghbmF2aWdhdG9yLm9uTGluZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBHb29nbGVBbmFseXRpY3MucG9zdCh1cmwpO1xuICB9O1xuXG4gIEdvb2dsZUFuYWx5dGljcy5wb3N0ID0gZnVuY3Rpb24gKHVybCkge1xuICAgIHZhciB4aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcbiAgICB4aHIub3BlbignUE9TVCcsIHVybCk7XG4gICAgeGhyLnNlbmQobnVsbCk7XG4gIH07XG5cbiAgR29vZ2xlQW5hbHl0aWNzLmRlZmF1bHRQYXJhbXMgPSBmdW5jdGlvbiAoKSB7XG4gICAgLy8gaHR0cHM6Ly9kZXZlbG9wZXJzLmdvb2dsZS5jb20vYW5hbHl0aWNzL2Rldmd1aWRlcy9jb2xsZWN0aW9uL3Byb3RvY29sL3YxL3BhcmFtZXRlcnNcbiAgICByZXR1cm4ge1xuICAgICAgdjogMSxcbiAgICAgIHRpZDogJ1VBLTQ3NjE1NzAwLTUnLFxuICAgIH07XG4gIH07XG5cbiAgcmV0dXJuIEdvb2dsZUFuYWx5dGljcztcbn0pKCk7XG4iXX0=
//# sourceURL=/home/champ/.atom/packages/build/lib/google-analytics.js
